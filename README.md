# tus_time_reversal_44mm_500kHz_v2

**Focused ultrasound simulation and lens design using k-Wave 1.4**  
Author: *Stephen Hicks*  

This MATLAB script simulates a focused ultrasound beam generated by a 44 mm circular aperture transducer at 500 kHz in water.  
It uses **time-reversal acoustics** to reconstruct the required wavefront and derive a **phase plate (acoustic lens)** heightmap.

---

## Features
- **Forward simulation** of a point-source focus using `kspaceFirstOrder3DG`.
- **Time-reversal playback** from the aperture with optional apodisation.
- Slice-based visualisation:
  - Axial (X–Z) slice
  - Coronal (Y–Z) slice
  - XY plane at the focal depth
  - On-axis axial pressure profile
- **Lens thickness map** computed from arrival-time differences, exportable as a 16-bit PNG for fabrication.
- Configurable parameters for frequency, aperture size, focal depth, grid spacing, and lens material speed.

---

## Requirements
- MATLAB (tested on R202x)
- [k-Wave Toolbox](http://www.k-wave.org/) 1.4
- Optional: CUDA-enabled GPU and compiled `kspaceFirstOrder-CUDA.exe` for faster runs.

---

## Usage
1. Install and add the k-Wave toolbox to your MATLAB path.
2. Adjust the **CONFIG** section of the script for your:
   - Speed of sound (`c0`)
   - Aperture diameter (`D_mm`)
   - Focal depth (`z_f_mm`)
   - Grid step (`dx`)
   - Lens material speed (`c_lens`)
3. Run the script.  
4. The script will generate:
   - Beam profile images (axial, coronal, focal spot, on-axis profile)
   - A `lens_heightmap_48mm_circle.png` file containing a normalised 16-bit heightmap.
   - A 3D surface preview of the lens.

---

## Example Outputs
Below are example results from the default configuration (`z_f_mm = 50 mm`):

**Focal Spot (XY at Focus)**  
![Focal Spot](focal_spot.png)

**Coronal Slice (Y–Z)**  
![Coronal Slice](coronal_slice.png)

**On-axis Axial Profile**  
![On-axis Profile](on_axis_profile.png)

**Time-Reversal Derived Lens**  
![Lens Heightmap](lens_heightmap.png)

---

## Notes
- The lens design includes fine ring features corresponding to phase compensation for sidelobes. These can be smoothed or phase-wrapped for manufacturing.
- Apodisation is applied with a Tukey window to reduce sidelobes; adjust `tuk_x` / `tuk_y` parameters to trade between peak gain and sidelobe suppression.
- The `gate` window around the focal arrival time controls how tightly the plots focus on the main lobe.

---

## License
This script is provided for research and development use. No warranty is expressed or implied.
